<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>爱美特水务花卉浇水记录</title>
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #4CAF50;
            --error: #ff4444;
            --text: #333;
            --border: #ddd;
            --bg: #f0f8f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--bg);
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            background: var(--secondary);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 1.3rem;
        }

        .section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input, select {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }

        button {
            padding: 10px 15px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        button:hover {
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--secondary);
            color: white;
        }

        .message {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        .error {
            background-color: #ffebee;
            color: var(--error);
        }
        
        .success {
            background-color: #e8f5e9;
            color: var(--primary);
        }

        .pending {
            color: #FF9800;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>爱美特水务花卉浇水记录</h1>
    </div>
    
    <div class="section">
        <div class="input-group">
            <input type="date" id="waterDate">
            <select id="flowerType">
                <option value="">选择花卉</option>
                <option value="龙血树">龙血树</option>
                <option value="马拉巴栗">马拉巴栗</option>
            </select>
        </div>
        <div class="input-group">
            <input type="text" id="userName" placeholder="记录人姓名" required>
            <button id="addButton">添加记录</button>
        </div>
        <div id="message" class="message" style="display:none;"></div>
    </div>

    <div class="section">
        <div class="input-group">
            <select id="filterType">
                <option value="all">所有花卉</option>
                <option value="龙血树">龙血树</option>
                <option value="马拉巴栗">马拉巴栗</option>
            </select>
            <button id="filterButton">筛选记录</button>
        </div>
    </div>

    <div class="section">
        <table id="recordsTable">
            <thead>
                <tr>
                    <th>浇水日期</th>
                    <th>花卉种类</th>
                    <th>记录人</th>
                    <th>状态</th>
                </tr>
            </thead>
            <tbody id="recordsBody">
                <tr>
                    <td colspan="4">正在加载数据...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // 配置
        const CONFIG = {
            DATA_URL: 'https://raw.githubusercontent.com/ws-ergua/flower-watering/main/data/records.json',
            PENDING_URL: 'https://raw.githubusercontent.com/ws-ergua/flower-watering/main/data/pending.json',
            LOCAL_KEY: 'flowerPendingRecords'
        };

        // 获取DOM元素
        const elements = {
            waterDate: document.getElementById('waterDate'),
            flowerType: document.getElementById('flowerType'),
            userName: document.getElementById('userName'),
            addButton: document.getElementById('addButton'),
            filterType: document.getElementById('filterType'),
            filterButton: document.getElementById('filterButton'),
            recordsBody: document.getElementById('recordsBody'),
            message: document.getElementById('message')
        };

        // 状态
        let records = [];
        let pendingRecords = [];

        // 初始化
        async function init() {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            elements.waterDate.value = today;
            
            // 加载数据
            await loadData();
            
            // 添加事件监听
            elements.addButton.addEventListener('click', addRecord);
            elements.filterButton.addEventListener('click', filterRecords);
            
            // 回车提交
            elements.userName.addEventListener('keypress', e => {
                if (e.key === 'Enter') addRecord();
            });
        }

        // 加载数据
        async function loadData() {
            showLoading();
            try {
                // 加载主记录
                const res = await fetch(`${CONFIG.DATA_URL}?t=${Date.now()}`);
                records = await res.json();
                
                // 加载待审核记录
                const pendingRes = await fetch(`${CONFIG.PENDING_URL}?t=${Date.now()}`);
                pendingRecords = await pendingRes.json();
                
                // 合并本地待提交记录
                const localPending = JSON.parse(localStorage.getItem(CONFIG.LOCAL_KEY)) || [];
                pendingRecords = [...pendingRecords, ...localPending];
                
                renderRecords();
                showMessage('数据加载成功', 'success');
            } catch (err) {
                console.error('加载失败:', err);
                showMessage('数据加载失败，请稍后重试', 'error');
            }
        }

        // 添加记录
        async function addRecord() {
            const date = elements.waterDate.value;
            const type = elements.flowerType.value;
            const user = elements.userName.value.trim();
            
            if (!date || !type || !user) {
                showMessage('请填写完整信息', 'error');
                return;
            }
            
            const newRecord = {
                id: Date.now(),
                date,
                type,
                user,
                timestamp: new Date().toISOString()
            };
            
            // 添加到本地待提交
            const pending = JSON.parse(localStorage.getItem(CONFIG.LOCAL_KEY)) || [];
            pending.push(newRecord);
            localStorage.setItem(CONFIG.LOCAL_KEY, JSON.stringify(pending));
            
            // 更新显示
            pendingRecords.push(newRecord);
            renderRecords();
            
            // 清空表单
            elements.userName.value = '';
            elements.flowerType.value = '';
            
            showMessage('记录已保存，等待管理员审核', 'success');
        }

        // 渲染记录
        function renderRecords() {
            const filter = elements.filterType.value;
            const filtered = filter === 'all' 
                ? [...records, ...pendingRecords]
                : [...records, ...pendingRecords].filter(r => r.type === filter);
            
            if (filtered.length === 0) {
                elements.recordsBody.innerHTML = '<tr><td colspan="4">暂无记录</td></tr>';
                return;
            }
            
            // 按日期排序
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            elements.recordsBody.innerHTML = filtered.map(record => `
                <tr>
                    <td>${record.date}</td>
                    <td>${record.type}</td>
                    <td>${record.user}</td>
                    <td>
                        ${records.some(r => r.id === record.id) ? '' : 
                         '<span class="pending">待审核</span>'}
                    </td>
                </tr>
            `).join('');
        }

        // 筛选记录
        function filterRecords() {
            renderRecords();
            showMessage('筛选已应用', 'success');
        }

        // 显示加载状态
        function showLoading() {
            elements.recordsBody.innerHTML = '<tr><td colspan="4">加载中...</td></tr>';
        }

        // 显示消息
        function showMessage(text, type) {
            elements.message.textContent = text;
            elements.message.className = `message ${type}`;
            elements.message.style.display = 'block';
            
            setTimeout(() => {
                elements.message.style.display = 'none';
            }, 3000);
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
